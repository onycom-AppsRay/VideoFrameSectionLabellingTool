<!DOCTYPE html>
<html>

<head>
  <title>Labeller - Select the video section</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="./app.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">

  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<body>

  <header>

    <!-- Upload Directory -->
    <section class="directory-upload">
      <div class="container">
        <div class="row">

          <!-- Video directory -->
          <div class="col-sm" id="video-directory-upload">
            <div class="input-group">
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="open-video-directory" webkitdirectory directory>
                <label class="custom-file-label" for="open-video-directory">비디오 폴더 선택</label>
              </div>
            </div>
          </div>

          <!-- JSON directory -->
          <div class="col-sm" id="json-directory-upload">
            <div class="input-group">
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="open-json-directory" webkitdirectory directory>
                <label class="custom-file-label" for="open-json-directory">완료된 파일 저장할 폴더 선택</label>
              </div>
            </div>
          </div>
          <!-- <div class="col-sm" id="json-directory-upload">
            <div class="input-group">
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="open-json-directory" webkitdirectory directory>
                <label class="custom-file-label" for="open-json-directory">완료된 파일 저장할 폴더 선택</label>
              </div>
            </div>
          </div> -->

        </div>
      </div>
    </section>

  </header>

  <main>

    <section>
      <div class="container">
        <div class="row">

          <!-- List files -->
          <div class="col-2" id="file-explorer">

            <!-- Video list -->
            <div class="video-file-list-container">
              <div class="video-file-list-title">
                <p>
                  <span>선택한 디렉토리:</span>
                  <span id="video-file-count">0</span>개
                </p>
              </div>

              <div class="video-file-container">
                <ol id="video-file-list">

                </ol>
              </div>
            </div>

            <!-- JSON list -->
            <div class="json-file-list-container">
              <div class="json-file-list-title">
                <p>
                  <span>완료된 파일:</span>
                  <span id="json-file-count">0</span>개
                </p>
              </div>

              <div class="json-file-container">
                <ol id="json-file-list">

                </ol>
              </div>

              <div class="json-file-create">
                <button type="button" class="btn btn-outline-primary btn-lg btn-block" id="json-file-create-btn">Create
                  JSON file</button>
              </div>
            </div>

          </div>

          <!-- Video visualization  -->
          <div class="col-8" id="video-explorer">

            <!-- Main frame -->
            <div class="main-frame-container">
              <div id="main-frame-title">
                <p>현재 파일: <span id="file-name"></span></p>
              </div>

              <div id="main-frame">
                <div id="main-frama-number-container">
                  <label>현재 인덱스</label>
                  <p id="frame-number">0</p>
                </div>
                <div id="main-frame-mask-container">
                  <canvas id="main-frame-mask"></canvas>
                </div>
              </div>
            </div>

            <!-- Sub frame -->
            <div class="sub-frame-container">
              <div id="sub-frame">
              </div>
            </div>

            <div id="sub-frame-button">
              <div class="input-group input-group-lg" id="sub-frame-input-container">
                <input type="number" class="form-control" id="start-frame-input" value=0 readonly autofocus>
                <input type="number" class="form-control" id="end-frame-input" value=0 readonly>
              </div>

              <div class="sub-frame-success-container">
                <button type="button" class="btn btn-outline-success btn-lg btn-block"
                  id="sub-frame-success">Next</button>
              </div>
            </div>

          </div>

          <!-- Selected loading section -->
          <div class="col-2" id="button-collection">

            <!-- Frame index 'input' tag group -->
            <div class="button-collection-title">
              <span>로딩 구간</span>
            </div>

            <div class="input-frame-index-group" id="input-container">
              <div class="input-group">
                <input type="text" aria-label="Start Frame" class="form-control" id="start-frame-1" readonly>
                <input type="text" aria-label="End Frame" class="form-control" id="end-frame-1" readonly>
                <div class="input-group-append">
                  <button class="btn btn-secondary" type="button">x</button>
                </div>
              </div>
            </div>

            <!-- Complete & Next Button -->
            <div class="complete-title">
              <span>완료 버튼</span>
            </div>

            <div class="complete-button">
              <button type="button" class="btn btn-outline-danger btn-lg btn-block"
                id="complete-submit">COMPLETE</button>
            </div>

          </div>

        </div>
      </div>
    </section>

  </main>

  <footer>

    <section>
      <div class="centered-text" id="company-info">
        <span>©ONYCOM, TestForte.AI</span>
      </div>
    </section>

  </footer>

  <!-- main -->
  <script>
    const cv = require('opencv4nodejs');
    const path = require('path');
    const fs = require('fs');
    const validate = require('validate.js');
    const dirTree = require('directory-tree');

    const START_INPUT_TAG = document.getElementById('start-frame-input');
    const END_INPUT_TAG = document.getElementById('end-frame-input');

    let SelectedLoadingSectionJsonFile;

    const VIDEO_FILE_LIST = 'video-file-list',
      JSON_FILE_LIST = 'json-file-list',
      VIDEO_FILE_COUNT = 'video-file-count',
      JSON_FILE_COUNT = 'json-file-count';

    let JSON_DIRECTORY_PATH,
      VIDEO_LIST,
      CLICKED_ELEMENT,
      TOTAL_FRAME_COUNT,
      FRAME_LIST = [],
      SELECTED_FRAME_LIST = [];
  </script>
  <script src="./components/file/JsonFile.js"></script>
  <script src="./components/file/LoadingInfo.js"></script>
  <script src="./components/image/image-helper.js"></script>
  <script src="./components/video/video-util.js"></script>
  <script src="./components/file/file.js"></script>
  <script src="./components/frame.js"></script>

  <!-- click event -->
  <script>
    window.addEventListener('click', this.onClickedElement, false);

    document.getElementById('open-video-directory').addEventListener('change', selectVideoDirectory, false);
    document.getElementById('open-json-directory').addEventListener('change', selectJSONFileDirectory, false);

    document.getElementById('start-frame-input').addEventListener('click', setAutofocus, false);
    document.getElementById('end-frame-input').addEventListener('click', setAutofocus, false);
    document.getElementById('sub-frame-success').addEventListener('click', onNext, false);
    document.getElementById('json-file-create-btn').addEventListener('click', onCreateJsonFile, false);

    document.getElementById('complete-submit').addEventListener('click', onCompleteSubmit, false);

    function onClickedElement(e) {
      CLICKED_ELEMENT = e.target;

      if (CLICKED_ELEMENT.className == 'frame') {
        onSelectedFrame(CLICKED_ELEMENT);
        return;
      }

      if (CLICKED_ELEMENT.parentElement.id == 'video-file-list') {
        renderVideo(e.target.dataset.path, e.target.innerText);
        deleteAllSelectedFrameIndexInputTag()
        return;
      }

      if (CLICKED_ELEMENT.id == 'btn-delete-selected-frame-index-input') {
        deleteSelectedFrameIndexInputGroup(e);
        return;
      }
    }

    // frame hover
    function frameSpotlight(canvas) {
      canvas.style.position = 'relative';
      canvas.style.outline = '5px solid red';
      canvas.style.zIndex = '1';
    }

    function frameSpotout(canvas) {
      canvas.style.outline = '';
      canvas.style.zIndex = '';
    }

    function onNext() {
      // 1) Validate input value
      const startFrameIndex = START_INPUT_TAG.value;
      const endFrameIndex = END_INPUT_TAG.value;

      if (validateSelectedFrameIndex(startFrameIndex, endFrameIndex)) {
        // 2) Create frame value input
        createSelectedFrameIndexInputTag(startFrameIndex, endFrameIndex);

        // 3) Mark the selected section
        markSelectedSection(startFrameIndex, endFrameIndex, 0.3);

        // 4) Initialize input tag
        initializeInputTag();
      }
    }

    function onCompleteSubmit() {
      if (confirm(`Create '.json' files?`)) {
        onSuccess();
      } else return;
    }

    function onCreateJsonFile() {
      // TODO(yhpark): 파일 생성 후 모두 초기화 시켜야 한다.
      if (!confirm(`'.json' 파일 생성 시, 현재 디렉터리에 대한 파일 리스트가 초기화 됩니다.`)) {
        return;
      }

      const jsonFileName = SelectedLoadingSectionJsonFile.getJSONFileName();
      const jsonData = SelectedLoadingSectionJsonFile.makeJSON();

      createFile(JSON_DIRECTORY_PATH, jsonFileName, 'json', jsonData);
    }
  </script>
  <script src="./components/keyboard.js"></script>
</body>

</html>