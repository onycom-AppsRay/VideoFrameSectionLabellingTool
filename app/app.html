<!DOCTYPE html>
<html>

<head>
  <title>Labeller - Select the video section</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="./app.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">

  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<body>

  <header>

    <!-- Upload Directory -->
    <section class="directory-upload">
      <div class="container">
        <div class="row">

          <!-- Video directory -->
          <div class="col-sm" id="video-directory-upload">
            <div class="input-group">
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="open-video-directory" webkitdirectory directory>
                <label class="custom-file-label" for="open-video-directory">비디오 폴더 선택</label>
              </div>
            </div>
          </div>

          <!-- JSON directory -->
          <div class="col-sm" id="json-directory-upload">
            <div class="input-group">
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="open-json-file">
                <label class="custom-file-label" id="json-file-path" for="open-json-file">저장할 파일 선택('.json')</label>
              </div>
            </div>
          </div>

          <div class="col-sm" id="json-directory-upload">
            <div class="input-group">
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="validate-json-file">
                <label class="custom-file-label" id="json-file-path" for="validate-json-file">JSON 내의 겹치는 데이터 찾기</label>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

  </header>

  <main>

    <section>
      <div class="container">
        <div class="row">

          <!-- List files -->
          <div class="col-2" id="file-explorer">

            <!-- Video list -->
            <div class="video-file-list-container">
              <div class="video-file-list-title">
                <p>
                  <span>선택한 디렉토리:</span>
                  <span id="video-file-count">0</span>개
                </p>
              </div>

              <div class="video-file-container">
                <ol id="video-file-list"></ol>
              </div>
            </div>

            <!-- JSON list -->
            <div class="json-file-list-container">
              <div class="json-file-list-title">
                <p>
                  <span>완료된 파일:</span>
                  <span id="json-file-count">0</span>개
                </p>
              </div>

              <div class="json-file-container">
                <ol id="json-file-list"></ol>
              </div>

              <div class="json-file-create">
                <button type="button" class="btn btn-outline-primary btn-lg btn-block" id="write-json-file-btn">WRITE</button>
              </div>
            </div>

          </div>

          <!-- Video visualization  -->
          <div class="col-8" id="video-explorer">

            <!-- Main frame -->
            <div class="main-frame-container">
              <div id="main-frame-title">
                <div class="container">
                  <div class="row">
                    <div class="col-sm">
                      현재 파일: <span id="file-name"></span>
                    </div>
                    <div class="col-sm">
                      실행 시간: <span id="file-run-time"></span>
                    </div>
                    <div class="col-sm">
                      프레임 단위: <span id="video-file-fps"></span>
                    </div>
                  </div>
                </div>
              </div>

              <div id="main-frame">
                <div id="main-frama-number-container">
                  <label>현재 인덱스</label>
                  <p id="frame-number">0</p>
                  <p id="now-video-time"></p>
                </div>
                <div id="main-frame-mask-container">
                  <canvas id="main-frame-mask"></canvas>
                </div>
              </div>
            </div>

            <!-- Sub frame -->
            <div class="sub-frame-container">
              <div id="sub-frame">
              </div>
            </div>

            <div id="sub-frame-button">
              <div class="input-group input-group-lg" id="sub-frame-input-container">
                <input type="number" class="form-control" id="start-frame-input" value=0 readonly autofocus>
                <input type="number" class="form-control" id="end-frame-input" value=0 readonly>
              </div>

              <div class="sub-frame-success-container">
                <button type="button" class="btn btn-outline-success btn-lg btn-block"
                  id="sub-frame-success">NEXT</button>
              </div>
            </div>

          </div>

          <!-- Selected loading section -->
          <div class="col-2" id="button-collection">

            <!-- Frame index 'input' tag group -->
            <div class="button-collection-title">
              <span>로딩 구간</span>
            </div>

            <div class="input-frame-index-group" id="input-container">
              <div class="input-group">
                <input type="text" aria-label="Start Frame" class="form-control" id="start-frame-1" readonly>
                <input type="text" aria-label="End Frame" class="form-control" id="end-frame-1" readonly>
                <div class="input-group-append">
                  <button class="btn btn-secondary" type="button">x</button>
                </div>
              </div>
            </div>

            <!-- Complete & Next Button -->
            <div class="complete-title">
              <span>완료 버튼</span>
            </div>

            <div class="complete-button">
              <button type="button" class="btn btn-outline-danger btn-lg btn-block"
                id="complete-submit">COMPLETE</button>
            </div>

          </div>

        </div>
      </div>
    </section>

  </main>

  <footer>

    <section>
      <div class="centered-container">
        <span>©ONYCOM, TestForte.AI</span>
      </div>
    </section>

  </footer>

  <div class="overray-spinner">
    <span class="spinner-count"></span>
  </div>

  <!-- main -->
  <script>
    const cv = require('opencv4nodejs');
    const path = require('path');
    const fs = require('fs');
    const validate = require('validate.js');
    const dirTree = require('directory-tree');

    const START_INPUT_TAG = document.getElementById('start-frame-input');
    const END_INPUT_TAG = document.getElementById('end-frame-input');

    let SelectedLoadingSectionJsonFile;

    let VIDEO_DIR_PATH;

    const VIDEO_FILE_LIST = 'video-file-list',
      JSON_FILE_LIST = 'json-file-list',
      VIDEO_FILE_COUNT = 'video-file-count',
      JSON_FILE_COUNT = 'json-file-count';

    let JSON_DIRECTORY_PATH,
      VIDEO_LIST,
      CLICKED_ELEMENT,
      TOTAL_FRAME_COUNT,
      FRAME_LIST = [],
      SELECTED_FRAME_LIST = [],
      VIDEO_FILE_FPS;
  </script>
  <script src="./components/file/JsonFile.js"></script>
  <script src="./components/file/LoadingInfo.js"></script>
  <script src="./components/image/image-helper.js"></script>
  <script src="./components/video/video-util.js"></script>
  <script src="./components/file/file.js"></script>
  <script src="./components/frame.js"></script>

  <!-- click event -->
  <script>
    window.addEventListener('click', this.onClickedElement, false);

    document.getElementById('open-video-directory').addEventListener('change', selectVideoDirectory, false);
    document.getElementById('open-json-file').addEventListener('change', selectJSONFile, false);

    document.getElementById('start-frame-input').addEventListener('click', setAutofocus, false);
    document.getElementById('end-frame-input').addEventListener('click', setAutofocus, false);
    document.getElementById('sub-frame-success').addEventListener('click', onNext, false);
    document.getElementById('sub-frame-success').addEventListener('mouseup', function (e) {
      e.target.blur();
    }, false);
    document.getElementById('write-json-file-btn').addEventListener('click', onWriteJsonFile, false);

    document.getElementById('complete-submit').addEventListener('click', onCompleteSubmit, false);

    document.getElementById('validate-json-file').addEventListener('change', onValidateJSONFile, false);

    function onValidateJSONFile(e) {
      const fileList = e.target.files;
      const filePath = fileList[0].path;
      const fileName = fileList[0].name;

      const readBuffer = fs.readFileSync(filePath);
      const jsonData = JSON.parse(readBuffer);

      const tempJSONDataMap = new Map();
      const jsonList = new JSONFile(fileName);

      Object.entries(jsonData.loadingData).forEach(([key, value]) => {
        const fileName = value.name;
        const fileData = value.data;

        if(tempJSONDataMap.has(fileName)) {
          tempJSONDataMap.set(fileName, tempJSONDataMap.get(fileName) + 1)
        } else {
          tempJSONDataMap.set(fileName, 1);

          const loadingInfo = new LoadingInfo(fileName, fileData);
          jsonList.pushLoadingData(loadingInfo.getLoadingInfo());
        }
      });

      fs.writeFile(filePath, jsonList.makeJSON(), (err) => {
        if(err) throw err;
        console.log('success');
      })

      console.log(tempJSONDataMap);
    }

    function onClickedElement(e) {
      CLICKED_ELEMENT = e.target;

      if (CLICKED_ELEMENT.className == 'frame') {
        onSelectedFrame(CLICKED_ELEMENT);
        return;
      }

      if (CLICKED_ELEMENT.parentElement.id == 'video-file-list') {
        renderVideo(e.target.dataset.path, e.target.innerText);
        deleteAllSelectedFrameIndexInputTag()
        return;
      }

      if (CLICKED_ELEMENT.id == 'btn-delete-selected-frame-index-input') {
        deleteSelectedFrameIndexInputGroup(e);
        return;
      }
    }

    // frame hover
    function frameSpotlight(canvas) {
      canvas.style.position = 'relative';
      canvas.style.outline = '5px solid red';
      canvas.style.zIndex = '1';
    }

    function frameSpotout(canvas) {
      canvas.style.outline = '';
      canvas.style.zIndex = '';
    }

    function onNext() {
      // 1) Validate input value
      const startFrameIndex = START_INPUT_TAG.value;
      const endFrameIndex = END_INPUT_TAG.value;

      if (validateSelectedFrameIndex(startFrameIndex, endFrameIndex)) {
        // 2) Create frame value input
        createSelectedFrameIndexInputTag(startFrameIndex, endFrameIndex);

        // 3) Mark the selected section
        markSelectedSection(startFrameIndex, endFrameIndex, 0.1);

        // 4) Initialize input tag
        initializeInputTag();

        return false;
      }
    }

    function onCompleteSubmit() {
      if (confirm(`로딩 구간에 대한 정보를 저장 하시겠습니까?`)) {
        onSuccess();
      } else return;
    }

    function onWriteJsonFile(e) {
      if (!SelectedLoadingSectionJsonFile) {
        alert('저장할 데이터가 없습니다.');
        return;
      }

      const jsonData = SelectedLoadingSectionJsonFile.makeJSON();

      confirmJSONFile(JSON_DIRECTORY_PATH);
      writeFile(JSON_DIRECTORY_PATH, jsonData);
    }
  </script>
  <script src="./components/keyboard.js"></script>
</body>

</html>