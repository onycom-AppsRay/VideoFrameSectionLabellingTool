<!DOCTYPE html>
<html>

<head>
  <title>Labeller - Select the video section</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="./app.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">

  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

</head>

<body style="background-color: red;">

  <header class="centered-text">
    <section>
      <h3>Loding Section Labeling Tool</h3>
    </section>

    <section>
      <div class="container">
        <div class="row">

          <div class="col-sm">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroupFileAddon01">Upload</span>
              </div>
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="open-video-directory"
                  aria-describedby="inputGroupFileAddon01" webkitdirectory directory>
                <label class="custom-file-label" for="open-video-directory">a .png or .jpg file:</label>
              </div>
            </div>
          </div>

          <div class="col-sm">
            <div class="input-group">
              <div class="input-group-prepend">
                <span class="input-group-text" id="inputGroupFileAddon01">Upload</span>
              </div>
              <div class="custom-file">
                <input type="file" class="custom-file-input" id="open-json-directory"
                  aria-describedby="inputGroupFileAddon01" webkitdirectory directory>
                <label class="custom-file-label" for="open-json-directory">완료된 파일 저장할 폴더 선택</label>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>
  </header>

  <main>
    <section>
      <div class="container">
        <div class="row">
          <!-- file list -->
          <div class="col-2" id="file-explorer">

            <div class="video-file-list-title">
              <span>선택한 디렉토리</span>
              <p><span id="video-file-count">0</span>개</p>
            </div>

            <div class="video-file-container">
              <ol id="video-file-list">

              </ol>
            </div>

            <div class="json-file-list-title">
              <span>완료된 파일</span>
              <p><span id="json-file-count">0</span>개</p>
            </div>

            <!-- BUG(yhpark): json 파일은 선택되지 않게 해야한다. -->
            <div class="json-file-container">
              <ol id="json-file-list">

              </ol>
            </div>

          </div>

          <!-- video explorer -->
          <div class="col-8" id="video-explorer">

            <div id="main-frame-title">
              <span>메인 프레임</span>
              <p>현재 파일: <span id="file-name"></span></p>
            </div>

            <div id="main-frame">
              <label>현재 인덱스</label>
              <p id="frame-number">0</p>
              <canvas id="main-frame-mask"></canvas>
            </div>

            <div id="sub-frame-title">
              <span>프레임 흐름</span>
            </div>

            <div id="sub-frame">
            </div>

            <div id="sub-frame-button">
              <div class="input-group input-group-lg ">
                <div class="input-group-prepend">
                  <span class="input-group-text" id="inputGroup-sizing-lg">Start</span>
                </div>
                <input type="text" class="form-control" aria-label="Sizing example input"
                  aria-describedby="inputGroup-sizing-lg" id="start-frame-input" value=0 readonly autofocus>

                <div class="input-group-prepend">
                  <span class="input-group-text" id="inputGroup-sizing-lg">End</span>
                </div>
                <input type="text" class="form-control" aria-label="Sizing example input"
                  aria-describedby="inputGroup-sizing-lg" id="end-frame-input" value=0 readonly>
              </div>

              <button type="button" class="btn btn-secondary btn-lg btn-block" id="sub-frame-success">Next</button>
            </div>

          </div>

          <!-- button collection -->
          <div class="col-2" id="button-collection">

            <!-- Frame index 'input' tag group -->
            <div class="button-collection-title">
              <span>버튼 레이아웃</span>
            </div>

            <div class="input-frame-index-group" id="input-container">
              <div class="input-group">
                <input type="text" aria-label="Start Frame" class="form-control" id="start-frame-1" readonly>
                <input type="text" aria-label="End Frame" class="form-control" id="end-frame-1" readonly>
                <div class="input-group-append">
                  <button class="btn btn-secondary" type="button">x</button>
                </div>
              </div>
            </div>

            <!-- Complete & Next Button -->
            <div class="complete-title">
              <span>완료 버튼</span>
            </div>

            <div class="complete-button">
              <button type="button" class="btn btn-outline-danger btn-lg btn-block" id="complete-submit"
                style="height: 100%">COMPLETE</button>
            </div>

          </div>

        </div>
      </div>
    </section>
  </main>

  <footer>
    <section>footer</section>
  </footer>

  <!-- main -->
  <script>
    const cv = require('opencv4nodejs');

    const START_INPUT_TAG = document.getElementById('start-frame-input');
    const END_INPUT_TAG = document.getElementById('end-frame-input');

    let CLICKED_ELEMENT;
    let TOTAL_FRAME_COUNT;  // video load 시 초기화
    let FRAME_LIST = [];
    let SELECTED_FRAME_LIST = [];
  </script>
  <script src="./components/image/image-helper.js"></script>
  <script src="./components/video/video-util.js"></script>
  <script src="./components/file/file.js"></script>
  <script src="./components/frame.js"></script>

  <!-- click event -->
  <script>
    window.addEventListener('click', this.onClickedElement, false);

    document.getElementById('open-video-directory').addEventListener('change', selectVideoDirectory, false);
    document.getElementById('open-json-directory').addEventListener('change', selectJSONFileDirectory, false);

    document.getElementById('start-frame-input').addEventListener('click', setAutofocus, false);
    document.getElementById('end-frame-input').addEventListener('click', setAutofocus, false);
    document.getElementById('sub-frame-success').addEventListener('click', onNext, false);

    document.getElementById('complete-submit').addEventListener('click', onCompleteSubmit, false);

    function onClickedElement(e) {
      CLICKED_ELEMENT = e.target;

      if (CLICKED_ELEMENT.className == 'frame') {
        onSelectedFrame(CLICKED_ELEMENT);
        return;
      }
      
      if (CLICKED_ELEMENT.parentElement.id == 'video-file-list') {
        selectVideo(e);
        deleteAllSelectedFrameIndexInputTag()
        return;
      }

      if (CLICKED_ELEMENT.id == 'btn-delete-selected-frame-index-input') {
        deleteSelectedFrameIndexInputGroup(e);
        return;
      }
    }

    // frame hover
    function frameSpotlight(canvas) {
      canvas.style.position = 'relative';
      canvas.style.outline = '5px solid red';
      canvas.style.zIndex = '1';
    }

    function frameSpotout(canvas) {
      canvas.style.outline = '';
      canvas.style.zIndex = '';
    }

    function onNext() {
      // 1) Validate input value
      const startFrameIndex = START_INPUT_TAG.value;
      const endFrameIndex = END_INPUT_TAG.value;

      if (validateSelectedFrameIndex(startFrameIndex, endFrameIndex)) {
        // 2) Create frame value input
        createSelectedFrameIndexInputTag(startFrameIndex, endFrameIndex);

        // 3) Mark the selected section
        markSelectedSection(startFrameIndex, endFrameIndex, 0.3);

        // 4) Initialize input tag
        initializeInputTag();
      }
    }

    function onCompleteSubmit() {
      if (confirm(`Create '.json' files?`)) {
        onSuccess();
      } else return;
    }
  </script>
  <script>
    const path = require('path');
    const SAMPLE_VIDEO = 'sample.mp4';

    const videoCapture = new cv.VideoCapture(path.resolve(SAMPLE_VIDEO));
    let frame = videoCapture.read();

    let i = 0;

    while (!frame.empty) {
      FRAME_LIST.push(frame);
      frame = frame.resizeToMax(200);

      // frame flow part
      const canvas = document.createElement('canvas');
      canvas.setAttribute('class', `frame`);
      canvas.setAttribute('id', i);
      canvas.setAttribute('onmouseover', 'frameSpotlight(this)');
      canvas.setAttribute('onmouseout', 'frameSpotout(this)');

      renderImage(frame, canvas);
      renderImageOnText(canvas);

      const container = document.getElementById('sub-frame');
      container.appendChild(canvas);

      i++;
      frame = videoCapture.read();
    }

    renderImage(FRAME_LIST[0], document.getElementById('main-frame-mask'));

    // View file name 
    document.getElementById('file-name').innerText = SAMPLE_VIDEO;

    TOTAL_FRAME_COUNT = getTotalFrameCount();
  </script>
</body>

</html>